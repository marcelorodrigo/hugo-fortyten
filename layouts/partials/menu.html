{{- /*
Renders a menu for the given menu ID with support for nested menus.

Hugo menu system documentation:
https://gohugo.io/configuration/menus/

Nested menus are created by setting the 'parent' property to the parent item's identifier.
Child items should NOT have identifiers for best compatibility.

Example:
  menus:
    main:
      - identifier: 'about'
        name: 'About'
        pageRef: '/about'
        weight: 40
      - name: 'Our Story'
        pageRef: '/about/our-story'
        parent: 'about'        # References the parent's IDENTIFIER
        weight: 41
      - name: 'Our Team'
        pageRef: '/about/team'
        parent: 'about'        # References the parent's IDENTIFIER
        weight: 42
      - name: 'Marcelo'
        url: 'https://example.com'
        parent: 'Our Team'     # References the parent's NAME (since 'Our Team' has no identifier)
        weight: 43

@context {page} page The current page.
@context {string} menuID The menu ID.

@example: {{ partial "menu.html" (dict "menuID" "main" "page" .) }}
*/}}

{{- $page := .page }}
{{- $menuID := .menuID }}

{{- with index site.Menus $menuID }}
  
  <!-- DESKTOP MENU (horizontal, visible on md and above) -->
  <nav aria-label="Main navigation" class="flex items-center gap-6">
    <ul class="flex flex-row space-x-6">
      {{- /* Only render items that have identifiers (top-level items) */ -}}
      {{- range . }}
        {{- if .Identifier }}
          {{- partial "inline/menu/item.html" (dict "page" $page "item" .) }}
        {{- end }}
      {{- end }}
    </ul>
    {{- /* Search button (only shown if site search is enabled, desktop only) */ -}}
    {{- if site.Params.enable_site_search }}
    <button 
      type="button" 
      id="search-button" 
      class="text-gray-700 hover:text-sky-700 transition ease-in-out p-2 rounded-md hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-sky-500"
      aria-label="Open search"
      title="Search (Ctrl+K or Cmd+K)"
    >
      <ion-icon name="search" class="text-xl" aria-hidden="true"></ion-icon>
    </button>
    {{- end }}
  </nav>
  
  <!-- MOBILE MENU PANEL (slide-in from left, hidden on md and above) -->
  <div id="mobile-menu-overlay" 
       class="fixed inset-0 bg-black/50 z-40 hidden transition-opacity duration-300" 
       aria-hidden="true"
       role="presentation"></div>
  
  <aside id="mobile-menu-panel" 
         class="fixed top-0 left-0 h-full w-72 bg-white z-50 
                transform -translate-x-full transition-transform duration-300 ease-in-out
                overflow-y-auto shadow-xl"
         aria-label="Mobile navigation"
         aria-hidden="true"
         role="navigation">
    
    <!-- Close button -->
    <div class="flex justify-end p-4 border-b border-orange-100">
      <button 
        id="mobile-menu-close" 
        type="button"
        class="text-gray-700 hover:text-sky-700 transition ease-in-out p-2 rounded-md hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-sky-500"
        aria-label="Close menu"
      >
        <ion-icon name="close" class="text-xl" aria-hidden="true"></ion-icon>
      </button>
    </div>
    
    <!-- Mobile menu content (treeview - all expanded) -->
    <nav class="p-4">
      <ul class="space-y-1">
        {{- /* Render all items in mobile menu, including top-level items */ -}}
        {{- range . }}
          {{- partial "inline/menu/mobile-item.html" (dict "page" $page "item" . "level" 0) }}
        {{- end }}
      </ul>
    </nav>
  </aside>

{{- end }}

{{- define "partials/inline/menu/item.html" }}
  {{- $page := .page }}
  {{- $item := .item }}
  
  {{- $attrs := dict "href" $item.URL }}
  {{- $icon := $item.Params.icon }}
  {{- $iconSize := $item.Params.iconSize }}
  {{- if $page.IsMenuCurrent $item.Menu $item }}
    {{- $attrs = merge $attrs (dict "class" "active font-bold text-sky-700" "aria-current" "page") }}
  {{- else if $page.HasMenuCurrent $item.Menu $item }}
    {{- $attrs = merge $attrs (dict "class" "ancestor" "data-ancestor" "true") }}
  {{- end }}
  
  {{- $name := $item.Name }}
  {{- with $item.Identifier }}
    {{- with T . }}
      {{- $name = . }}
    {{- end }}
  {{- end }}
  
  {{- /* Check if item has children */ -}}
  {{- $hasChildren := gt (len $item.Children) 0 }}
  
  <li class="relative group flex items-center gap-1">
    <a class="text-md font-bold hover:text-sky-700 transition ease-in-out flex items-center gap-1 py-2" title="{{ $name }}"
      {{- range $k, $v := $attrs }}
        {{- with $v }}
          {{- printf " %s=%q" $k $v | safeHTMLAttr }}
        {{- end }}
      {{- end -}}
    >
      {{- with $icon }}
        <ion-icon name="{{ . }}"{{ with $iconSize }} size="{{ . }}"{{ end }} class="inline-block" aria-hidden="true"></ion-icon>
      {{- end }}
      {{ $name }}
      {{- if $hasChildren }}
        <ion-icon name="chevron-down" class="inline-block text-xs" aria-hidden="true"></ion-icon>
      {{- end }}
    </a>
    {{- if $hasChildren }}
      <ul role="menu" aria-label="Submenu for {{ $name }}" class="absolute left-0 top-full mt-2 w-max bg-white border border-gray-200 rounded-md shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50">
        {{- partial "inline/menu/render-children.html" (dict "children" $item.Children) }}
      </ul>
    {{- end }}
  </li>
{{- end }}

{{- define "partials/inline/menu/render-children.html" }}
  {{- range .children }}
    {{- $item := . }}
    <li class="relative group/submenu hover:bg-gray-100">
      <a href="{{ .URL }}" class="block px-4 py-2 text-md font-bold text-gray-900 hover:text-sky-700 transition ease-in-out flex items-center gap-1">
        {{- with .Params.icon }}
          <ion-icon name="{{ . }}"{{ with $item.Params.iconSize }} size="{{ . }}"{{ end }} class="inline-block" aria-hidden="true"></ion-icon>
        {{- end }}
        {{ .Name }}
        {{- if gt (len .Children) 0 }}
          <ion-icon name="chevron-forward" class="inline-block text-xs ml-auto" aria-hidden="true"></ion-icon>
        {{- end }}
      </a>
      {{- if gt (len .Children) 0 }}
        <ul role="menu" class="absolute left-full top-0 w-max bg-white border border-gray-200 rounded-md shadow-lg opacity-0 invisible group-hover/submenu:opacity-100 group-hover/submenu:visible transition-all duration-200 z-50 before:content-[''] before:absolute before:top-0 before:right-full before:w-2 before:h-full">
          {{- partial "inline/menu/render-children.html" (dict "children" .Children) }}
        </ul>
      {{- end }}
    </li>
  {{- end }}
{{- end }}

{{- define "partials/inline/menu/mobile-item.html" }}
  {{- $page := .page }}
  {{- $item := .item }}
  {{- $level := .level }}
  {{- $hasChildren := gt (len $item.Children) 0 }}
  
  {{- $paddingClass := "" }}
  {{- if eq $level 0 }}
    {{- $paddingClass = "" }}
  {{- else if eq $level 1 }}
    {{- $paddingClass = "pl-4" }}
  {{- else if eq $level 2 }}
    {{- $paddingClass = "pl-8" }}
  {{- else }}
    {{- $paddingClass = "pl-12" }}
  {{- end }}
  
  <li>
    {{- if or (not $item.Identifier) $hasChildren }}
      {{- /* Non-link parent or section header */ -}}
      <div class="flex items-center gap-2 py-2 px-3 rounded {{ $paddingClass }}">
        {{- with $item.Params.icon }}
          <ion-icon name="{{ . }}"{{ with $item.Params.iconSize }} size="{{ . }}"{{ end }} class="inline-block flex-shrink-0" aria-hidden="true"></ion-icon>
        {{- end }}
        <span class="font-bold text-gray-900">{{ $item.Name }}</span>
      </div>
    {{- else }}
      {{- /* Link item */ -}}
      {{- $attrs := dict "href" $item.URL }}
      {{- if $page.IsMenuCurrent $item.Menu $item }}
        {{- $attrs = merge $attrs (dict "class" "active text-sky-700 font-bold" "aria-current" "page") }}
      {{- end }}
      
      <a class="flex items-center gap-2 py-2 px-3 rounded text-gray-900 hover:text-sky-700 hover:bg-gray-50 transition ease-in-out {{ $paddingClass }}"
        {{- range $k, $v := $attrs }}
          {{- with $v }}
            {{- printf " %s=%q" $k $v | safeHTMLAttr }}
          {{- end }}
        {{- end -}}
      >
        {{- with $item.Params.icon }}
          <ion-icon name="{{ . }}"{{ with $item.Params.iconSize }} size="{{ . }}"{{ end }} class="inline-block flex-shrink-0" aria-hidden="true"></ion-icon>
        {{- end }}
        {{ $item.Name }}
      </a>
    {{- end }}
    
    {{- /* Recursively render children (always expanded in mobile) */ -}}
    {{- if $hasChildren }}
      <ul class="space-y-1">
        {{- range $item.Children }}
          {{- partial "inline/menu/mobile-item.html" (dict "page" $page "item" . "level" (add $level 1)) }}
        {{- end }}
      </ul>
    {{- end }}
  </li>
{{- end }}
