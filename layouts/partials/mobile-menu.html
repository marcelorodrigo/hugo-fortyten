{{- /*
Renders the mobile menu panel with slide-in animation using Alpine.js.

This partial renders the mobile menu overlay, panel, and treeview navigation.
It should be included outside any hidden containers to ensure proper visibility.

@context {page} page The current page.
@context {string} menuID The menu ID.

@example: {{ partial "mobile-menu.html" (dict "menuID" "main" "page" .) }}
*/}}

{{- $page := .page }}
{{- $menuID := .menuID }}

{{- with index site.Menus $menuID }}

<script>
  document.addEventListener('alpine:init', () => {
    Alpine.data('mobileMenu', () => ({
      isOpen: false,
      open() {
        this.isOpen = true;
        document.body.classList.add('overflow-hidden');
        this.$nextTick(() => this.$refs.closeBtn?.focus());
      },
      close() {
        this.isOpen = false;
        document.body.classList.remove('overflow-hidden');
        document.getElementById('mobile-menu-toggle')?.focus();
      },
      toggle() {
        this.isOpen ? this.close() : this.open();
      },
      init() {
        window.addEventListener('resize', () => {
          if (window.innerWidth >= 1024 && this.isOpen) {
            this.close();
          }
        });
      }
    }));
  });
</script>

<!-- Mobile Menu Container (Alpine.js component) -->
<div x-data="mobileMenu()"
@keydown.escape.window="isOpen && close()"
@mobile-menu-toggle.window="toggle()">

  <!-- MOBILE MENU OVERLAY (backdrop with fade transition) -->
  <div x-show="isOpen"
       x-transition:enter="transition-opacity ease-out duration-300"
       x-transition:enter-start="opacity-0"
       x-transition:enter-end="opacity-100"
       x-transition:leave="transition-opacity ease-in duration-300"
       x-transition:leave-start="opacity-100"
       x-transition:leave-end="opacity-0"
       @click="close()"
       class="fixed inset-0 bg-black/50 z-40" 
       aria-hidden="true"
       role="presentation"
       x-cloak></div>
  
  <!-- MOBILE MENU PANEL (slide-in from left) -->
  <aside x-show="isOpen"
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="-translate-x-full"
         x-transition:enter-end="translate-x-0"
         x-transition:leave="transition ease-in duration-300"
         x-transition:leave-start="translate-x-0"
         x-transition:leave-end="-translate-x-full"
         class="fixed top-0 left-0 h-full w-72 bg-white z-50 
                transform overflow-y-auto shadow-xl"
         aria-label="Mobile navigation"
         :aria-hidden="!isOpen"
         role="navigation"
         x-cloak>
    
    <!-- Header: Search + Close button -->
    <div class="flex justify-between items-center p-4 border-b border-orange-100">
      {{- /* Search button in mobile menu (only if search is enabled) */ -}}
      {{- if site.Params.enable_site_search }}
      <button 
        type="button"
        @click="close(); $dispatch('search-toggle')"
        class="text-gray-700 hover:text-sky-700 transition ease-in-out p-2 rounded-md hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-sky-500"
        aria-label="Open search"
      >
        <ion-icon name="search" class="text-xl pointer-events-none" aria-hidden="true"></ion-icon>
      </button>
      {{- else }}
      <div></div>{{- /* Empty spacer when search is disabled */ -}}
      {{- end }}
      
      <button 
        x-ref="closeBtn"
        type="button"
        @click="close()"
        class="text-gray-700 hover:text-sky-700 transition ease-in-out p-2 rounded-md hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-sky-500"
        aria-label="Close menu"
      >
        <ion-icon name="close" class="text-xl" aria-hidden="true"></ion-icon>
      </button>
    </div>
    
    <!-- Mobile menu content (treeview - all expanded) -->
    <nav class="p-4">
      <ul class="space-y-1">
        {{- /* Render all top-level items with children expanded */ -}}
        {{- range . }}
          {{- partial "inline/mobile-menu/item.html" (dict "page" $page "item" . "level" 0) }}
        {{- end }}
      </ul>
    </nav>
  </aside>
  
</div>

{{- end }}

{{- define "partials/inline/mobile-menu/item.html" }}
  {{- $page := .page }}
  {{- $item := .item }}
  {{- $level := .level }}
  {{- $hasChildren := gt (len $item.Children) 0 }}
  
  {{- /* Calculate indentation based on nesting level */ -}}
  {{- $paddingClass := "" }}
  {{- if eq $level 1 }}
    {{- $paddingClass = "pl-4" }}
  {{- else if eq $level 2 }}
    {{- $paddingClass = "pl-8" }}
  {{- else if ge $level 3 }}
    {{- $paddingClass = "pl-12" }}
  {{- end }}
  
  <li>
    {{- if $hasChildren }}
      {{- /* Parent item with children - render as header with link if URL exists */ -}}
      {{- if $item.URL }}
        <a href="{{ $item.URL }}" class="flex items-center gap-2 py-2 px-3 rounded text-gray-900 hover:text-sky-700 hover:bg-gray-50 transition ease-in-out font-bold {{ $paddingClass }}"
          {{- if $page.IsMenuCurrent $item.Menu $item }} aria-current="page"{{ end -}}
        >
          {{- with $item.Params.icon }}
            <ion-icon name="{{ . }}"{{ with $item.Params.iconSize }} size="{{ . }}"{{ end }} class="inline-block flex-shrink-0" aria-hidden="true"></ion-icon>
          {{- end }}
          {{ $item.Name }}
        </a>
      {{- else }}
        <div class="flex items-center gap-2 py-2 px-3 rounded font-bold text-gray-900 {{ $paddingClass }}">
          {{- with $item.Params.icon }}
            <ion-icon name="{{ . }}"{{ with $item.Params.iconSize }} size="{{ . }}"{{ end }} class="inline-block flex-shrink-0" aria-hidden="true"></ion-icon>
          {{- end }}
          <span>{{ $item.Name }}</span>
        </div>
      {{- end }}
      
      {{- /* Render children (always expanded) */ -}}
      <ul class="space-y-1">
        {{- range $item.Children }}
          {{- partial "inline/mobile-menu/item.html" (dict "page" $page "item" . "level" (add $level 1)) }}
        {{- end }}
      </ul>
    {{- else }}
      {{- /* Leaf item - render as link */ -}}
      <a href="{{ $item.URL }}" class="flex items-center gap-2 py-2 px-3 rounded text-gray-900 hover:text-sky-700 hover:bg-gray-50 transition ease-in-out {{ $paddingClass }}{{ if $page.IsMenuCurrent $item.Menu $item }} text-sky-700 font-bold{{ end }}"
        {{- if $page.IsMenuCurrent $item.Menu $item }} aria-current="page"{{ end -}}
      >
        {{- with $item.Params.icon }}
          <ion-icon name="{{ . }}"{{ with $item.Params.iconSize }} size="{{ . }}"{{ end }} class="inline-block flex-shrink-0" aria-hidden="true"></ion-icon>
        {{- end }}
        {{ $item.Name }}
      </a>
    {{- end }}
  </li>
{{- end }}
